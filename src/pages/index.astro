---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import SectionHeader from "../components/SectionHeader.astro";
import ProjectCard from "../components/ProjectCard.astro";
import FlagshipProject from "../components/FlagshipProject.astro";
import ContactForm from "../components/ContactForm.astro";
import { getCollection } from "astro:content";
import { getGitHubStars } from "../utils/github";

const allProjects = await getCollection("projects");
const projects = await Promise.all(
  allProjects
    .sort((a, b) => a.data.order - b.data.order)
    .map(async (project) => {
      if (project.data.github) {
        const stars = await getGitHubStars(project.data.github);
        return {
          ...project,
          data: {
            ...project.data,
            stars: stars,
          },
        };
      }
      return project;
    }),
);

const featured = projects.filter((p) => p.data.featured);
const other = projects.filter((p) => !p.data.featured);

const skillGroups = [
  {
    label: "Languages",
    items: ["TypeScript", "Python", "Go", "Lua", "C", "C#"],
  },
  {
    label: "Frontend",
    items: ["React", "Astro", "Vite", "HTML/CSS"],
  },
  {
    label: "Backend and Tools",
    items: ["FastAPI", "Solar2D", "CMake", "Git"],
  },
  {
    label: "Infrastructure",
    items: ["Linux", "Docker", "GitHub Actions", "Vercel"],
  },
];

const highlights = [
  {
    metric: "50k+",
    label: "Downloads across Python and C projects.",
  },
  {
    metric: "100k+",
    label: "Visitors across live deployments.",
  },
  {
    metric: "10+",
    label: "Listed repos for minimalist design.",
  },
  {
    metric: "Top 80",
    label: "GambitoR 4.0 at IIT Roorkee out of 100k+ participants.",
  },
  {
    metric: "Shastra 2026",
    label: "Qualified both rounds at IIT Madras. DSA, coding, maths, and reasoning against school and college students.",
  },
  {
    metric: "3rd Global",
    label: "Won Lumi Hackathon. Placed 3rd globally and received $200 in cash prizes.",
  },
];

const building = [
  {
    name: "HyPrism",
    description: "Multiplatform Hytale launcher with integrated mod management. Written in Go.",
    status: "active",
  },
  {
    name: "FR2: Reborn",
    description: "Complete multiplayer racing game remake. Built with Solar2D and Lua.",
    status: "active",
  },
  {
    name: "Needlelight",
    description: "Refined Lumafly assistant with cross platform tooling. Built with C# and Python.",
    status: "active",
  },
];
---

<Layout>
  <Header />

  <main>
    <section id="about" class="section fade-in">
      <div class="container">
        <SectionHeader title="about" number="01" />
        <div class="about-content">
          <p>
            I write software that ships. My work spans developer tooling,
            game engine internals, and web infrastructure. I build in Go,
            TypeScript, Python, and Lua, and I contribute to open source
            projects that people actually use.
          </p>
          <p>
            When I solve a problem, I publish the solution. When existing tools
            fall short, I build better ones. That approach has led to 50k+
            downloads, recognition across international hackathons, and a
            portfolio of tools used by developers worldwide.
          </p>
        </div>
      </div>
    </section>

    <section id="highlights" class="section fade-in">
      <div class="container">
        <SectionHeader title="highlights" number="02" />
        <div class="highlights-grid">
          {
            highlights.map((h, i) => (
              <div class="highlight-card slide-up" style={`animation-delay: ${i * 0.1}s`}>
                <span class="highlight-metric">{h.metric}</span>
                <span class="highlight-label">{h.label}</span>
              </div>
            ))
          }
        </div>
      </div>
    </section>

    <section id="projects" class="section fade-in">
      <div class="container">
        <SectionHeader title="featured work" number="03" />
        <div class="flagship-grid">
          {
            featured.map((project, index) => (
              <FlagshipProject
                title={project.data.title}
                description={project.data.description}
                tech={project.data.tech}
                github={project.data.github}
                live={project.data.live}
                stars={project.data.stars}
                index={index}
              />
            ))
          }
        </div>

        <h3 class="subsection-title">All Projects</h3>
        <div class="projects-grid">
          {
            other.map((project, index) => (
              <ProjectCard
                title={project.data.title}
                description={project.data.description}
                tech={project.data.tech}
                github={project.data.github}
                live={project.data.live}
                stars={project.data.stars}
                index={index}
              />
            ))
          }
        </div>
      </div>
    </section>

    <section id="skills" class="section fade-in">
      <div class="container">
        <SectionHeader title="stack" number="04" />
        <div class="skills-grouped">
          {
            skillGroups.map((group, gi) => (
              <div class="skill-group slide-up" style={`animation-delay: ${gi * 0.1}s`}>
                <span class="skill-group-label">{group.label}</span>
                <div class="skill-group-items">
                  {group.items.map((item) => (
                    <span class="skill-tag">{item}</span>
                  ))}
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </section>

    <section id="building" class="section fade-in">
      <div class="container">
        <SectionHeader title="currently building" number="05" />
        <div class="building-list">
          {
            building.map((item, i) => (
              <div class="building-item slide-up" style={`animation-delay: ${i * 0.1}s`}>
                <div class="building-status">
                  <span class="status-dot" />
                </div>
                <div class="building-info">
                  <span class="building-name">{item.name}</span>
                  <span class="building-desc">{item.description}</span>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </section>

    <section id="contact" class="section fade-in">
      <div class="container">
        <SectionHeader title="contact" number="06" />
        <ContactForm />
      </div>
    </section>
  </main>

  <script is:inline>
    if (typeof window !== "undefined") {
      const CACHE_TTL = 1000 * 60 * 15;
      const STORAGE_KEY = "project-star-cache";

      const readCache = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      };

      const writeCache = (cache) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cache));
        } catch {}
      };

      const parseRepo = (githubUrl) => {
        try {
          const { pathname } = new URL(githubUrl);
          const parts = pathname.split("/").filter(Boolean);
          if (parts.length < 2) return null;
          return { owner: parts[0], repo: parts[1] };
        } catch {
          return null;
        }
      };

      const updateBadge = (badge, stars) => {
        const countEl = badge.querySelector(".star-count");
        badge.dataset.stars = String(stars);
        badge.setAttribute("aria-label", `${stars} stars`);
        if (countEl) countEl.textContent = String(stars);
      };

      const hydrateStars = async () => {
        const badges = Array.from(
          document.querySelectorAll('[data-role="star-badge"][data-github]'),
        );

        if (!badges.length) return;

        const cache = readCache();
        const now = Date.now();

        for (const badge of badges) {
          const github = badge.getAttribute("data-github");
          if (!github) continue;

          const cached = cache[github];
          if (cached && now - cached.ts < CACHE_TTL) {
            updateBadge(badge, cached.stars);
            continue;
          }

          const parsed = parseRepo(github);
          if (!parsed) continue;

          try {
            const res = await fetch(
              `https://api.github.com/repos/${parsed.owner}/${parsed.repo}`,
            );
            if (!res.ok) continue;
            const data = await res.json();
            const stars = Number(data?.stargazers_count ?? 0);
            if (Number.isFinite(stars)) {
              updateBadge(badge, stars);
              cache[github] = { stars, ts: now };
              writeCache(cache);
            }
          } catch {}
        }
      };

      if (document.readyState === "complete") {
        hydrateStars();
      } else {
        window.addEventListener("load", hydrateStars, { once: true });
      }
    }
  </script>
</Layout>

<style>
  .section {
    position: relative;
    padding: var(--section-padding);
  }

  /* About */
  .about-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .about-content p {
    font-size: var(--font-size-base);
    line-height: 1.75;
    color: var(--secondary-text);
    max-width: 36rem;
  }

  /* Highlights */
  .highlights-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    margin-top: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: var(--rounded-corner);
    overflow: hidden;
    background: var(--border-color);
  }

  .highlight-card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1.5rem;
    background: var(--bg-color);
  }

  .highlight-metric {
    font-size: var(--font-size-x-large);
    font-weight: 600;
    color: var(--primary-text);
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  .highlight-label {
    font-size: var(--font-size-xs);
    color: var(--tertiary-text);
    line-height: 1.4;
    font-weight: 400;
  }

  /* Projects */
  .flagship-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
    margin-bottom: 3rem;
  }

  .subsection-title {
    font-size: var(--font-size-small);
    font-weight: 500;
    color: var(--tertiary-text);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 1rem;
    font-family: var(--font-mono);
  }

  .projects-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
  }

  /* Skills */
  .skills-grouped {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    margin-top: 1.5rem;
  }

  .skill-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .skill-group-label {
    font-family: var(--font-mono);
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: var(--tertiary-text);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .skill-group-items {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .skill-tag {
    font-size: var(--font-size-small);
    font-weight: 500;
    color: var(--secondary-text);
    background: transparent;
    padding: 0.3rem 0.6rem;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    transition: var(--transition-smooth);
  }

  .skill-tag:hover {
    color: var(--primary-text);
    border-color: var(--accent-color);
    transform: translateY(-1px);
  }

  /* Currently Building */
  .building-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-top: 1.5rem;
  }

  .building-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--border-color);
  }

  .building-item:last-child {
    border-bottom: none;
  }

  .building-status {
    padding-top: 0.4rem;
  }

  .status-dot {
    display: block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent-color);
    animation: pulse 2s ease-in-out infinite;
  }

  .building-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .building-name {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--primary-text);
    letter-spacing: -0.01em;
  }

  .building-desc {
    font-size: var(--font-size-small);
    color: var(--tertiary-text);
    line-height: 1.5;
    font-weight: 400;
  }

  @media (max-width: 768px) {
    .highlights-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .skills-grouped {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .about-content p {
      font-size: var(--font-size-small);
    }

    .flagship-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
