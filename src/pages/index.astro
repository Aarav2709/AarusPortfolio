---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import SectionHeader from "../components/SectionHeader.astro";
import ProjectCard from "../components/ProjectCard.astro";
import ContactForm from "../components/ContactForm.astro";
import AchievementCard from "../components/AchievementCard.astro";
import { getCollection } from "astro:content";
import { getGitHubStars } from "../utils/github";

const allProjects = await getCollection("projects");
const projects = await Promise.all(
  allProjects
    .sort((a, b) => a.data.order - b.data.order)
    .map(async (project) => {
      if (project.data.github) {
        const stars = await getGitHubStars(project.data.github);
        return {
          ...project,
          data: {
            ...project.data,
            stars: stars,
          },
        };
      }
      return project;
    }),
);

const skills = ["HTML", "CSS", "JavaScript", "Python", "React", "Astro", "C"];

const achievements = [
  {
    title: "Minimal Portfolio Design Recognition",
    description:
      "Listed across 10+ famous websites and repositories for minimalist design excellence.",
  },
  {
    title: "Famous Across Globe",
    description:
      "Crossed 50k+ downloads across my Python and C projects, with nearly 100k visitors across my websites.",
  },
  {
    title: "GambitoR 4.0 - IIT Roorkee",
    description:
      "Appreciated by the judges for the best PPT Design across the whole competition after qualifying Round 1 among 100k+ participants across India. Selected in top 80 for the 3-day final competition.",
  },
  {
    title: "Student HackPad - International Hackathon Runner Up",
    description:
      "Secured 4th position globally with project 'CyberQuest Jr', winning $100 in awards.",
  },
];
---

<Layout>
  <Header />

  <main>
    <section id="about" class="section fade-in">
      <div class="container">
        <SectionHeader title="about" number="01" />
        <div class="about-content">
          <p>
            I have a keen interest in game development, web applications, and
            automation scripts. In my free time, I enjoy working on personal
            projects, contributing to open-source, and exploring new programming
            languages. I'm always looking for new challenges and opportunities
            to collaborate with other developers. If you're interested in
            working together or just want to chat about tech, feel free to reach
            out.
          </p>
        </div>
      </div>
    </section>

    <section id="achievements" class="section fade-in">
      <div class="container">
        <SectionHeader title="achievements" number="02" />
        <div class="achievements-grid">
          {
            achievements.map((achievement, index) => (
              <AchievementCard
                title={achievement.title}
                description={achievement.description}
                index={index}
              />
            ))
          }
        </div>
      </div>
    </section>

    <section id="projects" class="section fade-in">
      <div class="container">
        <SectionHeader title="projects" number="03" />
        <div class="projects-grid">
          {
            projects.map((project, index) => (
              <ProjectCard
                title={project.data.title}
                description={project.data.description}
                tech={project.data.tech}
                github={project.data.github}
                live={project.data.live}
                stars={project.data.stars}
                index={index}
              />
            ))
          }
        </div>
      </div>
    </section>

    <section id="skills" class="section fade-in">
      <div class="container">
        <SectionHeader title="skills" number="04" />
        <div class="skills-list">
          {skills.map((skill) => <span class="skill-tag">{skill}</span>)}
        </div>
      </div>
    </section>

    <section id="setup" class="section fade-in">
      <div class="container">
        <SectionHeader title="tools & setup" number="05" />
        <div class="misc-grid">
          <div class="misc-item slide-up stagger-1">
            <span class="misc-number">01</span>
            <h3>AI Assistance</h3>
            <div class="misc-content">
              <span class="highlight">gemini 3.0 pro</span> for frontend help.<br
              />
              <span class="highlight">chatgpt 5.1 codex max</span> for project structure.<br
              />
              <span class="highlight">claude opus 4.5</span> for backend.
            </div>
          </div>

          <div class="misc-item slide-up stagger-2">
            <span class="misc-number">02</span>
            <h3>Current Device</h3>
            <div class="misc-content">
              <span class="highlight">intel i3 11th gen</span> @4.1ghz<br />
              <span class="highlight">8gb ddr4</span> @2666mhz<br />
              <span class="highlight">intel uhd</span> graphics<br />
              <span class="highlight">i use arch btw.</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="contact" class="section fade-in">
      <div class="container">
        <SectionHeader title="get in touch" number="06" />
        <ContactForm />
      </div>
    </section>
  </main>

  <script is:inline>
    if (typeof window !== "undefined") {
      const CACHE_TTL = 1000 * 60 * 15; // 15 minutes
      const STORAGE_KEY = "project-star-cache";

      const readCache = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      };

      const writeCache = (cache) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cache));
        } catch {
          /* ignore quota errors */
        }
      };

      const parseRepo = (githubUrl) => {
        try {
          const { pathname } = new URL(githubUrl);
          const parts = pathname.split("/").filter(Boolean);
          if (parts.length < 2) return null;
          return { owner: parts[0], repo: parts[1] };
        } catch {
          return null;
        }
      };

      const updateBadge = (badge, stars) => {
        const countEl = badge.querySelector(".star-count");
        badge.dataset.stars = String(stars);
        badge.setAttribute("aria-label", `${stars} stars`);
        if (countEl) countEl.textContent = String(stars);
      };

      const hydrateStars = async () => {
        const badges = Array.from(
          document.querySelectorAll('[data-role="star-badge"][data-github]'),
        );

        if (!badges.length) return;

        const cache = readCache();
        const now = Date.now();

        for (const badge of badges) {
          const github = badge.getAttribute("data-github");
          if (!github) continue;

          const cached = cache[github];
          if (cached && now - cached.ts < CACHE_TTL) {
            updateBadge(badge, cached.stars);
            continue;
          }

          const parsed = parseRepo(github);
          if (!parsed) continue;

          try {
            const res = await fetch(
              `https://api.github.com/repos/${parsed.owner}/${parsed.repo}`,
            );
            if (!res.ok) continue;
            const data = await res.json();
            const stars = Number(data?.stargazers_count ?? 0);
            if (Number.isFinite(stars)) {
              updateBadge(badge, stars);
              cache[github] = { stars, ts: now };
              writeCache(cache);
            }
          } catch {
            /* ignore fetch errors */
          }
        }
      };

      if (document.readyState === "complete") {
        hydrateStars();
      } else {
        window.addEventListener("load", hydrateStars, { once: true });
      }
    }
  </script>
</Layout>

<style>
  .section {
    position: relative;
    padding: var(--section-padding);
  }

  .about-content p {
    font-size: var(--font-size-large);
    line-height: 1.8;
    color: var(--secondary-text);
    max-width: 38rem;
  }

  .projects-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
  }

  .skills-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .skill-tag {
    font-size: var(--font-size-small);
    font-weight: 600;
    color: var(--accent-color);
    background: var(--accent-color-alpha);
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    transition: var(--transition-smooth);
  }

  .skill-tag:hover {
    background: var(--accent-color);
    color: var(--bg-color);
    transform: translateY(-1px);
    opacity: 1;
  }

  .achievements-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .misc-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  .misc-item {
    background: var(--glass-bg);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border: 1px solid var(--border-color);
    border-radius: var(--rounded-corner);
    padding: 1.75rem;
    transition: var(--transition-bounce);
    position: relative;
    box-shadow: var(--shadow);
  }

  .misc-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-raised);
    border-color: var(--accent-color);
  }

  .misc-number {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent-color);
    margin-bottom: 1rem;
    display: block;
  }

  .misc-item h3 {
    font-size: var(--font-size-large);
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--primary-text);
    line-height: 1.3;
  }

  .misc-content {
    color: var(--secondary-text);
    line-height: 1.7;
    font-size: var(--font-size-small);
    font-weight: 400;
  }

  .highlight {
    color: var(--accent-color);
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .achievements-grid {
      grid-template-columns: 1fr;
    }

    .about-content p {
      font-size: var(--font-size-base);
    }

    .misc-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
